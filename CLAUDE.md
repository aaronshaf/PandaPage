# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a PDF.js rewrite using MoonBit and WebAssembly. The project consists of a MoonBit-based PDF parser that compiles to WebAssembly and a browser demo interface.

## Development Commands

All MoonBit commands must be run from the `pdf-parser/` directory with the MoonBit toolchain in PATH:

```bash
cd pdf-parser
export PATH="$HOME/.moon/bin:$PATH"
```

### Building and Testing
- `moon build --target wasm-gc` - Build WebAssembly module (primary target)
- `moon build --target js` - Build JavaScript module 
- `moon run src/main` - Run the main executable locally for testing
- `moon test` - Run all tests
- `moon fmt` - Format MoonBit source code
- `moon check` - Type check without building

### Important Architecture Rule
**ALL JavaScript and WebAssembly code MUST be generated by MoonBit**
- NO hand-written JavaScript files
- NO manual WASM manipulation
- Use MoonBit's JS target for CLI tools, utilities, and browser integration
- This ensures type safety and consistency across the entire codebase

### Browser Testing
- Open `index.html` directly in browser to test the web interface
- Use `python3 -m http.server 8000` from project root for local server if needed

## Architecture

### Core Components

1. **PDF Parser Module** (`pdf-parser/src/lib/`):
   - `pdf_types.mbt` - Type definitions for PDF document structure (PDFObject enum, PDFDocument struct, etc.)
   - `pdf_parser.mbt` - Core parsing functions (parse_pdf_header, find_pdf_objects)
   - `hello.mbt` - Public API interface that bridges to JavaScript

2. **WebAssembly Target**: 
   - Builds to `pdf-parser/target/wasm-gc/release/build/main/main.wasm`
   - Uses MoonBit's WASM-GC compilation target for performance

3. **JavaScript Target**:
   - ALL JavaScript code MUST be generated by MoonBit
   - NO hand-written JavaScript - use `moon build --target js` instead
   - This includes CLI tools, browser integration, and utilities

4. **Browser Integration**:
   - `index.html` loads MoonBit-generated WASM and JS modules
   - All PDF processing logic lives in MoonBit code

### PDF Document Model

The PDF parsing is built around a type-safe representation:

- `PDFObject` enum handles all PDF primitive types (strings, numbers, arrays, dictionaries, streams, references)
- `PDFDocument` struct contains header, objects map, cross-reference table, and trailer
- Parser currently handles basic header validation and object detection

### MoonBit Package Structure

- Main module: `ashafovaloff/pdf-parser` 
- Library package: `ashafovaloff/pdf-parser/lib` (contains core logic)
- Main package: `ashafovaloff/pdf-parser/main` (imports lib, provides executable)

## Technology Stack & Architecture Goals

### Core Technologies
- **WebAssembly (WASM-GC)**: Primary execution target for PDF parsing
- **Web Workers**: Background processing to avoid UI blocking
- **SharedArrayBuffer**: Zero-copy data sharing between threads for large PDFs
- **OffscreenCanvas**: GPU-accelerated rendering for smooth performance
- **Streaming & Progressive Loading**: Handle large PDF files incrementally

### Planned Viewing Modes
- **Canvas Mode**: Traditional paginated PDF rendering (desktop-optimized)
- **PDF-to-Markdown Mode**: Text-based view for mobile devices and accessibility
- **Hybrid Mode**: Adaptive rendering based on device capabilities

## Current Implementation Status

- âœ… PDF header parsing and validation
- âœ… Basic object detection in PDF streams  
- âœ… WebAssembly compilation pipeline
- âœ… Browser demo interface with WASM loading
- ðŸš§ WASM data passing (debugging needed)
- ðŸš§ Web Worker integration
- ðŸš§ OffscreenCanvas rendering
- ðŸš§ Streaming parser architecture

## MoonBit Language Notes

- Uses functional programming paradigms with strong typing
- Struct fields use `:` syntax (`field : Type`)
- Pattern matching with `match` expressions
- Error handling with `Result[T, E]` types
- Array/Map collections with functional methods
- WASM exports must be properly typed for JavaScript interop
- Language reference available at: https://www.moonbitlang.com/llms.txt

### Common MoonBit Syntax Updates
- `starts_with()` deprecated â†’ use `has_prefix()`
- `Char::from_int()` deprecated â†’ use `Int::unsafe_to_char()`
- `substring(0, 2000)` â†’ use `substring(start=0, end=2000)`
- `string[i]` deprecated â†’ use `string.charcode_at(i)` then `Int::unsafe_to_char()`
- `None => {}` â†’ use `None => ()` (empty tuple for unit type)
- `!condition` â†’ use `condition == false` or `condition.not()`

## Testing Notes

### Running Tests
- `moon test` - Run all tests in the project
- Test files must end with `_test.mbt`
- Use `@lib.function_name` to call functions from the library module
- Tests use `test "name" { ... }` syntax
- Use `fail("message")` to fail a test with a message

### PDF Structure Reality
- Real PDFs often use glyph IDs in content streams, not direct Unicode
- Unicode text is typically found in:
  - ToUnicode CMaps for font mappings
  - Document metadata (Title, Author, etc.)
  - Outline/bookmark entries
- Our text extraction handles both direct text and Unicode hex strings
- Unicode hex strings start with BOM (FEFF) followed by UTF-16 BE hex pairs